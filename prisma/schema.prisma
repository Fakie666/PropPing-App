generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  AGENT
}

enum LeadIntent {
  VIEWING
  MAINTENANCE
  GENERAL
  UNKNOWN
}

enum LeadStatus {
  OPEN
  QUALIFIED
  SCHEDULED
  CLOSED
  NEEDS_HUMAN
  OPTED_OUT
  OUT_OF_AREA
}

enum MaintenanceStatus {
  OPEN
  LOGGED
  IN_PROGRESS
  CLOSED
  NEEDS_HUMAN
  OPTED_OUT
  OUT_OF_AREA
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageChannel {
  SMS
  INTERNAL
}

enum DocumentType {
  EPC
  GAS_SAFETY
  EICR
  SMOKE_CO
  LEGIONELLA
  OTHER
}

enum ComplianceStatus {
  OK
  DUE_SOON
  OVERDUE
  MISSING
}

enum JobType {
  LEAD_FOLLOW_UP
  COMPLIANCE_REMINDER
  OWNER_NOTIFICATION
}

enum JobStatus {
  PENDING
  SENT
  FAILED
  CANCELED
}

enum CallOutcome {
  ANSWERED
  NO_ANSWER
  BUSY
  FAILED
}

enum Severity {
  ROUTINE
  URGENT
  EMERGENCY
}

model Tenant {
  id                           String                @id @default(cuid())
  name                         String
  twilioPhoneNumber            String                @unique
  forwardToPhoneNumber         String
  ownerNotificationPhoneNumber String
  timezone                     String                @default("Europe/London")
  businessHoursJson            Json?
  allowedPostcodePrefixes      String[]
  bookingUrlViewings           String?
  bookingUrlCalls              String?
  messageTemplatesJson         Json?
  compliancePolicyJson         Json?
  createdAt                    DateTime              @default(now())
  updatedAt                    DateTime              @updatedAt
  users                        User[]
  leads                        Lead[]
  maintenanceRequests          MaintenanceRequest[]
  messages                     Message[]
  calls                        Call[]
  properties                   Property[]
  complianceDocuments          ComplianceDocument[]
  jobs                         Job[]
  optOuts                      OptOut[]
}

model User {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  email        String   @unique
  passwordHash String
  role         UserRole @default(ADMIN)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([tenantId])
}

model Lead {
  id              String      @id @default(cuid())
  tenantId        String
  tenant          Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  callerPhone     String
  sourceCallSid   String?
  status          LeadStatus  @default(OPEN)
  intent          LeadIntent  @default(UNKNOWN)
  flowStep        Int         @default(0)
  name            String?
  desiredArea     String?
  postcode        String?
  propertyQuery   String?
  requirements    String?
  callbackTime    DateTime?
  firstOutboundAt DateTime?
  closedAt        DateTime?
  notes           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  messages        Message[]
  jobs            Job[]

  @@index([tenantId, callerPhone, status])
}

model MaintenanceRequest {
  id               String            @id @default(cuid())
  tenantId         String
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  callerPhone      String
  sourceCallSid    String?
  status           MaintenanceStatus @default(OPEN)
  flowStep         Int               @default(0)
  severity         Severity?
  name             String?
  propertyAddress  String?
  postcode         String?
  issueDescription String?
  callbackTime     DateTime?
  closedAt         DateTime?
  needsHuman       Boolean           @default(false)
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  messages         Message[]
  jobs             Job[]

  @@index([tenantId, callerPhone, status])
}

model Message {
  id                   String              @id @default(cuid())
  tenantId             String
  tenant               Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  direction            MessageDirection
  channel              MessageChannel      @default(SMS)
  fromPhone            String
  toPhone              String
  body                 String
  twilioMessageSid     String?
  leadId               String?
  lead                 Lead?               @relation(fields: [leadId], references: [id], onDelete: SetNull)
  maintenanceRequestId String?
  maintenanceRequest   MaintenanceRequest? @relation(fields: [maintenanceRequestId], references: [id], onDelete: SetNull)
  createdAt            DateTime            @default(now())

  @@index([tenantId, fromPhone, toPhone, createdAt])
  @@index([leadId])
  @@index([maintenanceRequestId])
}

model Call {
  id            String      @id @default(cuid())
  tenantId      String
  tenant        Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  callerPhone   String
  toPhone       String
  twilioCallSid String?     @unique
  dialStatus    String?
  outcome       CallOutcome
  answered      Boolean     @default(false)
  createdAt     DateTime    @default(now())

  @@index([tenantId, createdAt])
}

model Property {
  id                  String               @id @default(cuid())
  tenantId            String
  tenant              Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  propertyRef         String
  addressLine1        String
  addressLine2        String?
  city                String?
  postcode            String
  notes               String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  complianceDocuments ComplianceDocument[]

  @@unique([tenantId, propertyRef])
  @@index([tenantId, postcode])
}

model ComplianceDocument {
  id             String           @id @default(cuid())
  tenantId       String
  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  propertyId     String
  property       Property         @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  documentType   DocumentType
  status         ComplianceStatus @default(MISSING)
  issueDate      DateTime?
  expiryDate     DateTime?
  filePath       String?
  lastReminderAt DateTime?
  notes          String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@unique([propertyId, documentType])
  @@index([tenantId, status, expiryDate])
  @@index([propertyId, documentType])
}

model Job {
  id                   String              @id @default(cuid())
  tenantId             String
  tenant               Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  type                 JobType
  status               JobStatus           @default(PENDING)
  runAt                DateTime
  payload              Json
  attempts             Int                 @default(0)
  maxAttempts          Int                 @default(3)
  lastError            String?
  sentAt               DateTime?
  canceledAt           DateTime?
  lockedAt             DateTime?
  lockedBy             String?
  leadId               String?
  lead                 Lead?               @relation(fields: [leadId], references: [id], onDelete: SetNull)
  maintenanceRequestId String?
  maintenanceRequest   MaintenanceRequest? @relation(fields: [maintenanceRequestId], references: [id], onDelete: SetNull)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  @@index([status, runAt])
  @@index([tenantId, type, status])
}

model OptOut {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  phone     String
  reason    String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, phone])
}
